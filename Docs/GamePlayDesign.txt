# 玩法策划

#### 潜行玩法
潜行玩法的基础是观察与躲避，这首先提出了要求，使得玩家能够在短时间内观察到敌人动向，并规划出自己的路线。为了满足这一要求，我们设计了：

* 统观全局的制高点

* 鹰眼：能够透视和标注敌人/出口/拾取物的特殊能力

茂盛的草丛分布在关卡当中，为玩家提供了：

* 躲避敌人的地点
* 观察敌人动向的地点
* 关卡路线的引导与参照


为了丰富潜行体验，我们添加了一些特殊能力来辅助潜行，包括：

* 定身术：面对单个难以对付的敌人时特别有效
* 隐身术：用于穿越多个敌人监视的道路

在某些情况下，玩家也可以利用可攀爬的物体来躲避敌人的视线。我们设计了VR攀爬系统，可攀爬的物体包括但不限于：

* 梯子
* 窗户
* 房梁


玩家通过鹰眼技能可以看到哪些物体是可攀爬的，而哪些是不能的。

围绕着潜行，我们设计了一套敌人AI逻辑。

敌人有三个状态：Normal，Warning，SuperWarning，Fight（按照敌人受惊程度的顺序，Normal最轻，Fight最严重）。默认处于Normal状态。

玩家如果惊动了敌人，敌人的警戒值会上升。如果敌人没有看见玩家，则警戒值会下降。敌人的状态会随着警戒值的上升和下降自动切换，切换逻辑如下图所示。



敌人的三种状态行动逻辑如下：

* Normal：敌人没有看到玩家，会按照默认设置进行巡逻/站岗/工作/摸鱼。
* Warning：敌人被惊动了，开始警戒，但仍然没有发现玩家，会走向引起他注意的地方探查。
* Fight：敌人意识到了玩家的存在，进入战斗模式，玩家已经难以甩开敌人，只能选择快速解决掉敌人。
* SuperWarning：敌人意识到了玩家的存在，但不清楚玩家的位置，随时警戒。如果看到玩家，警戒值会迅速上涨进入Fight模式。

敌人有许多种类，潜行时需要格外关注的是哨兵，他们通常站在哨塔上进行站岗，如果被他们发现，他们会第一时间通知周围所有的敌人，并通报玩家的位置。

此外，我们还设计了吸引敌人注意力的玩法，来让玩家在潜行中占据更多的主动性：

* 场景中散布着易碎的陶罐，玩家通过投掷/用石头砸/用弓箭射可以使之破碎，吸引敌人前往罐子破碎时所在的地方。
* 场景中还有不易碎的水缸，玩家可以通过用石头砸/用弓箭射使之发出声响，达到吸引敌人的效果。
#### 战斗玩法
当玩家被敌人发现，或者玩家想要提前解决威胁的时候，会采取战斗操作。

战斗是基于投掷物和弓箭的，在得到弓箭（第二关末尾部分）之前，玩家只能依靠扔石头来进行战斗，因此在这个阶段，玩家的战斗能力被限制，关卡设计也不鼓励战斗。

在得到弓箭之后，玩家可以拾取散落在地图中的箭，并且存储在自己的背包当中（最多只能存储三支箭）。地图中的箭会随着游戏测试不断调整摆放位置，来创造一个平衡的资源管理体验。



普通的箭可以直接解决掉敌人，但如果敌人是重甲类型的，则需要调整策略。重甲敌人免疫普通弓箭的伤害，要应对重甲敌人，玩家可以：

* 潜行躲过敌人
* 利用场景当中的机关，如落石等解决敌人
* 使用火箭：将箭放在火焰上可以暂时点燃箭头，重甲敌人身上的藤甲会被火引燃
  addImage

我们还为战斗添加了一种特殊能力：护盾术，来提高战斗当中的容错率。
最后，为潜行玩法设计的定身术/隐身术等特殊能力，也可以自由运用在战斗当中，以达到出奇制胜的效果。
#### 特殊能力
我们为玩家添加了一些可以主动释放的特殊能力，从而丰富游戏体验，也为关卡设计提供了更多的可能性。
具体特殊能力如下：

* 鹰眼：提供暂时的透视效果，并且用不同颜色标注敌人/通路/拾取物

* 定身术：能够短暂定住单一敌人，服务于潜行/战斗
addImage
* 隐身术：能够使自己隐身，但离敌人太近还是会被发觉
addImage
* 护盾术：为自己套上一层护盾，受到伤害时破裂并抵消伤害
addImage
* 隔空移物：能够远程操纵物体

其中，鹰眼，定身术，隐身术，护盾术需要通过绘制“星图”的方式释放。

“星图技能”是我们设计的一套适配VR的技能释放机制，简而言之，玩家需要绘制不同的星图来释放对应的技能。而先前提到的“制高点”则兼具技能学习的功用，玩家将会在此遇见一位重要NPC，并由他来传授玩家对应的技能。




星图技能的释放需要消耗法力点数，法力点散落在地图中，需要玩家通过探索进行获取。法力点不仅能激励玩家的探索，还有引路的作用。
addImage
#### 场景互动与解谜
我们会根据上述已有的玩家能力设计解谜关卡，使之位于地图主线和分支路线当中，解谜要素包括：
* 鹰眼技能可以让你看到场景里所有可以互动的机关
* 弓箭/火箭与场景机关的互动（悬垂的重物，油灯，可以燃烧的场景物体）
* 星图绘制和场景机关的互动（玩家需要通过某种方法获得破关用的星图并绘制）
* 定身术和场景机关的互动
* 隔空移物和场景机关的互动

--------------------------------------------------------------------------------

# 程序设计

### VR操作模块
VR操作模块的核心在于如下几个类：

* VRPawn：VR操作中最为核心的类，用于处理VR控制器输入的各种行为，如抓握，开始绘制星图，监控手部动作以触发提示和隔空移物等。
* PlayerState：用于存储玩家状态信息。
* MotionController：用于处理玩家和手部动作有关的操作（主要是抓取），左右手各一个。
* GrabComponent：拥有此组件的Actor可以拥有被抓取的功能，在其中可以对具体抓取类型进行设置，并对被抓取做出反应。
#### VRPawn
VRPawn是玩家操纵的VR角色，拥有两个MotionController分别代表左手和右手。
VRPawn实现了以下功能：
* 检测并实现玩家移动操作
* 根据VR头显位置动态更新玩家胶囊体高度实现蹲起操作
* 检测玩家抓取操作，交给MotionController处理
* 检测实现玩家摔落伤害
* 检测玩家星图绘制操作，交由相关类处理
* 检测玩家UI操作
* 检测并切换玩家手部是否在背包中的状态，便于MotionController进一步利用
* 实现玩家草丛躲藏，利用后处理添加视效
* 实现玩家受伤害和自动恢复逻辑
* 实现手部悬浮UI的引导逻辑，并检测引导是否被满足
#### MotionController
MotionController代表玩家的两只手的位置，并定义了手部动作处理逻辑。
MotionController实现了以下功能：
* 抓取和松开指定物体
* 检测手部周围可以抓取的物体
* 将物体放进/拿出背包
* 物体在两只手中的相互倒换
* 隔空移物功能
#### PlayerState
PlayerState用于存储玩家的数据，具体如下：
* 背包中的物品信息
* 特殊能力的习得信息
* 玩家的生命，法力等信息
#### GrabComponent
GrabComponent用于处理Owner的被抓取操作，其中预设了几种常用抓取类型：
* Free：物体保持被抓取时相对手的位置
* Snap：物体被自动吸附到手中心
* Weapon Snap：武器被自动吸附到手上预设好的插槽位置
* Human Body：创建物理控制实现拖动人体

此外，GrabComponent还预留了Custom类型。需要自定义抓取逻辑的Actor只需要继承实现自定义抓取接口，就能实现自定义抓取。

### VR玩法模块
#### 物理形体
场景里的所有具有物理的形体都在如下图所示的继承体系当中。


* WorldDynamic：场景中所有具有物理的非生物物体。如悬垂的石头，水缸等等。
* Grabbable：场景中所有可以被抓取的WorldDynamic，拥有GrabComponent。如陶罐，石头等等。
* Weapon：场景中可以被拾取的武器。如弓箭。
#### 特殊能力
##### 能力释放
星图绘制释放技能涉及到如下类：

* VRPawn：检测到星图绘制操作，创建StarDrawManager，开始绘制操作。
* StarDrawManager：检测玩家手部位置，管理相关特效，记录绘制轨迹。玩家绘制完成后，将星图对应的技能信息移交SkillReleaseManager，由其进行技能释放。
* SkillReleaseManager：根据传入的技能信息释放对应的技能。
##### 具体能力
* 鹰眼：后处理材质+自定义深度实现描边透视效果。
* 定身术：所有能够被定身的类（WorldDynamic，Enemy）都实现了IStasisable接口。接口函数包含被定身和解除定身。对于WorldDynamic，停止其模拟物理行为，并禁止抓取。对于敌人，停止其逻辑与动画的运行，并添加视觉特效。
  当玩家释放定身术时，SkillReleaseManager创建StasisManager类，其功能有：
	* 检测玩家手部动作，判断定身时机
	* 判断要定身的敌人，并对其定身
* 隐身术todo
* 护盾术todo

#### 攀爬
能够攀爬的物体是特殊的可抓取物体，不继承自WorldDynamic，其借助GrabComponent的自定义抓取功能实现了攀爬功能。其实现了：
* 抓取时，保持手部位置不变，并对玩家位置进行补偿。
* 松手时，检测玩家身下的地面，并进行缓慢站立。
#### 伤害
伤害系统的核心是ITakeDamage接口，实现了该接口就代表能够受到伤害。伤害的信息由结构体DamageInfo来表示，包含：
* 伤害类型：判断伤害的类型，如来自钝器或者利器，抑或法术
* 伤害量：伤害的基本量
* 额外效果：伤害是否附加额外效果，如火焰，毒药等

不同的类对伤害有不同的反应。
* 敌人和玩家：能受到所有类型的伤害，但存在例外（如重甲兵免疫普通弓箭）
* 场景：伤害可以和场景中的物体进行互动。例如悬吊重物的绳子受伤害会断，瓦罐受伤害会碎。

伤害的造成者在碰撞/重叠事件中通过调用接口函数来造成伤害。

#### 存档
存档系统的主要类如下所示：


ISavable：定义要存档的Actor的接口，包含以下功能：
* 获取Actor的唯一ID
* 获取Actor的存档信息
* 加载Actor的存档信息

SaveManager：用于在游戏中进行保存和加载操作，功能如下：
* 根据存档文件，加载存档中的Actor状态
* 获取汇总游戏中所有需要存档的Actor信息，并将其存储在硬盘当中

### AI模块
#### 感知系统
感知系统是敌人 AI 的一个核心子系统，负责检测玩家是否处于隐蔽态，并根据不同条件调整敌人对玩家的感知和反应。
潜行系统主要由两个部分组成：
* AIController -- 敌人感知与决策中枢
* MasterActor -- 游戏全局单例，负责给敌人发放任务

##### AIController
AIController 负责通过视觉听觉感官接收感知数据，根据玩家的潜行状态与环境因素决定敌人行为逻辑。

敌人对玩家的感知级别有四层，AIController通过不同的感官来感知环境，提高警戒度，进入不同的级别


核心功能：
* 感知系统整合：接入UE内置的AIPerception，自定义视觉感知并使用默认的听觉感知来检测玩家。
* 视觉感知：根据玩家在可视范围内相对敌人位置动态调整潜行值增长速度，增加身后以及周边视角视觉。
* 听觉感知：在一定范围内检测玩家引起的噪音
* 行为触发：根据警戒值触发不同的事件，进入对应的状态，同时触发信号传递给MasterActor。

##### MasterActor
MasterRef是游戏的全局AI管理与任务分发中心，负责收集每一个敌人的感知状态，根据不同的状态和游戏情况分发任务给敌人，同时负责敌人与敌人之间的交互。

核心功能：
* 任务分发：根据敌人的警戒状态和敌人属性分发任务，支持多种任务类型，比如巡逻任务、搜查任务、攻击任务等，敌人的规划执行系统根据分发的任务执行相应的动作。
* 全局调度优化：协调敌人与敌人之间的交互，例如组成小队进攻，用不同的进攻队形接近玩家。

#### 规划执行系统
规划执行系统负责将敌人的任务转化为一系列可执行的底层动作，并在游戏中有序灵活的执行这些动作。

本系统由两个主要部分组成：
* GOAP规划组件
* 状态树执行器
##### GOAP规划组件
GOAP（面向目标的动作规划）是一种常用的游戏AI决策方式，根据当前环境状态和可用动作，自动规划一条能达成目标的最优路径。
整个GOAP规划组件由四个类组成：
* Goap_Goal：敌人的目标基类，每一个MasterActor分发的任务目标都继承这个基类，记录目标的具体信息，达成条件和优先级等。
* Goap_Action：敌人的动作基类，敌人执行的具体动作都继承该基类，记录该动作的名称，消耗，执行的前提条件等，不包含具体的执行逻辑。
* Goap_WorldModel：记录并修改当前的环境状态，Planner根据这些状态信息规划出一条最优的可执行动作链。
* Goap_Planner：根据当前的环境状态和可用动作，自动规划出一条可执行动作链，规划算法为A*算法。

##### 状态树执行器
调用Planner获取动作序列，将生成的动作序列按顺序或条件执行，提供中断和插队接口。
每一个可执行动作对应状态树的任务，继承自StateTreeTask基类，不同的动作有不同的执行逻辑，且使用GamePlayTag唯一标识。
敌人在执行完该动作链后会重新进行规划，得到下一条可执行动作链。


#### 组件
组件系统是敌人AI的基础构建单元，每一个组件负责一个相对独立的功能模块，便于复用和扩展
核心组件：
* HealthComponent：负责管理敌人血量，提供查询和修改的接口
* EnemyUIComponent：负责管理敌人的UI显示，提供改变UI的接口
* DamageComponent：负责处理敌人收到的伤害
* AnimationComponent：负责处理敌人的特定动画效果，例如各种日常活动动画
* AnimalMovementComponent：动物的移动逻辑，用于骑马敌人的移动以及其他动物NPC
* SteeringBehaviourComponent：转向行为移动方式，能让敌人已更加自然的方式移动
* ArcherComponent：负责管理敌人的射箭逻辑，提供装备弓箭、射箭、瞄准等接口
* MeleeComponent：负责管理敌人的近战攻击逻辑，播放攻击动画等。
* GoapComponent：执行Goap规划
  
#### 动画
敌人动画系统负责将 AI 的逻辑状态和行为计划可视化，确保敌人的表现与实际行为同步。
动画系统采用状态驱动与事件触发相结合的方式，使用UE内置的动画蓝图、混合空间和动画蒙太奇等功能。
* 状态驱动：敌人的世界状态和执行状态会实时同步到动画蓝图变量中，例如移动速度，旋转角度等属性，通过动画状态机播放不同的动画，同时使用骨骼分层混合来实现动画之间的混合。
*  事件触发：特殊事件调用触发特定的动画蒙太奇，例如攻击逻辑会调用相应的攻击动画。
### 演出模块
演出模块负责在特定事件或剧情节点中，控制敌人或场景元素的表现，用于实现剧情演出和过场动画等非标准战斗行为。
主体使用UE内置的LevelSequence进行动画演出，自定义SequencePlayer蓝图类管理sequence演出。
#### SequencePlayer：

* 指定播放对应的Sequence演出
* 指定演出对应的NPC，实现程序动画和动画演出之间的转换
* 提供虚影模式，将动画演出用虚影的形式表现出来
* 提供播放接口，用于触发演出
  
#### 动画演出：
游戏制作动画演出流程：

1.使用NOKOV动捕设备拍摄动画，得到未处理的动捕数据。
2.使用MotionBuilder软件对得到的动捕数据进行重定向。
3.使用Cascadeur对重定向后的动画进行优化处理，解决抖动穿模等问题
4.使用UE内置的Sequencer结合各种场景元素以及Nigara特效搭建游戏内动画演出
